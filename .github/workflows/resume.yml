name: Resume Builder

on:
    push:
        branches:
            - main
        paths:
            - "resume_*.py"
            - ".github/workflows/resume.yml"
            - "src/resume/utils.py"
            - "src/template/resume.css"
            - "src/template/resume.html"
            - "src/template/index.html"

    # Allows running this workflow manually from the Actions tab
    workflow_dispatch:

jobs:
    generate-resume:
        name: Generate Resume
        runs-on: ubuntu-latest
        outputs:
            changed: ${{ steps.check_updates.outputs.changed }}
            skip: ${{ steps.generate.outputs.skip }}
        steps:
            - name: Install dependencies
              uses: awalsh128/cache-apt-pkgs-action@latest
              with:
                  packages: pandoc wkhtmltopdf poppler-utils
                  version: 1.0
            - name: Checkout repository
              uses: actions/checkout@v4
            - name: Run resume generation script
              id: generate
              run: |
                  if [[ -f "resume_${{ github.repository_owner }}.py" ]]; then
                      export PYTHONPATH=$PYTHONPATH:$PWD/src/
                      python3 -m resume.builder resume_${{ github.repository_owner }}.py -o ./static/assets
                      FILENAME=$(basename $(ls ./static/assets/Resume_*.pdf) .pdf)
                      echo | pandoc -t html --template=./src/template/index.html --metadata title="${FILENAME}" --variable filename="${FILENAME}" -o ./static/index.html
                      echo "skip=false" >> "${GITHUB_OUTPUT}"
                  else
                      echo "File 'resume_${{ github.repository_owner }}.py' not found. Couldn't build resume."
                      echo "skip=true" >> "${GITHUB_OUTPUT}"
                  fi
            - name: Check for resume changes
              id: check_updates
              if: steps.generate.outputs.skip == 'false'
              run: |
                  FILE_CHANGED=$(git diff ./static/assets | grep md | head -n 1)
                  UPDATE=$(python3 -c "print(str('${FILE_CHANGED}'.endswith('.md')).lower())")
                  echo "Re-upload resume: ${UPDATE}"
                  echo "changed=${UPDATE}" >> "${GITHUB_OUTPUT}"
            - name: Commit changes
              if: steps.generate.outputs.skip == 'false' && steps.check_updates.outputs.changed == 'true'
              run: |
                  git config --local user.name "github-actions[bot]"
                  git config --local user.email "github-actions[bot]@users.noreply.github.com"
                  git commit -a -m "pipeline: update resume"
            - name: Upload resume files
              if: steps.generate.outputs.skip == 'false' && steps.check_updates.outputs.changed == 'true'
              uses: ad-m/github-push-action@master
              with:
                  branch: main
                  github_token: ${{ secrets.GITHUB_TOKEN }}

    publish-site:
        name: Publish Site
        needs: generate-resume
        if: needs.generate-resume.outputs.skip == 'false' && needs.generate-resume.outputs.changed == 'true'
        uses: ./.github/workflows/website.yml
